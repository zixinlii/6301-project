<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mammography Interventions — Interactive Dashboard</title>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      /* 新主题：深色背景 + 柔和高饱和点缀 */
      --bg:#0b0f14; 
      --card:#0f1722; 
      --border:#1b2737;
      --muted:#a9b6d6; 
      --text:#eaf0fb; 
      --accent:#8ab4ff; 
      --ring:#223147;

      /* 调色板（与 Plotly colorway 保持一致） */
      --c1:#7dd3fc;  /* sky */
      --c2:#c4b5fd;  /* violet */
      --c3:#fca5a5;  /* coral */
      --c4:#fcd34d;  /* amber */
      --c5:#34d399;  /* emerald */
      --c6:#f472b6;  /* pink */
    }
    html,body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: "Inter", ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility;
    }
    .wrap{max-width:1200px; margin:32px auto; padding:0 16px;}
    h1{font-size: clamp(28px, 4vw, 44px); line-height:1.15; margin:0 0 8px; letter-spacing:.2px}
    .sub{color:var(--muted); margin-bottom:24px}
    .grid{display:grid; grid-template-columns: 1fr; gap:20px}
    @media(min-width:960px){ .grid{grid-template-columns: 1fr 1fr} }
    .card{
      background: radial-gradient(1200px 400px at 10% -20%, rgba(138,180,255,.08), transparent 60%),
                  radial-gradient(900px 300px at 110% 10%, rgba(125,211,252,.06), transparent 60%),
                  var(--card);
      border:1px solid var(--border); border-radius:18px; padding:22px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.02);
    }
    .card h2{margin:0 0 12px; font-size: clamp(18px, 2.5vw, 26px)}
    .note{color:var(--muted); margin-top:10px}
    .footer{color:var(--muted); margin-top:26px; font-size:14px}
    .error{color:#fda4af; font-weight:600}
    a{color:var(--accent)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Visualizing the Effects of Mail and Phone Interventions on Mammography Screening</h1>
    <div class="sub">Age distribution, compliance by intervention, and follow-up cognitive stage — built with Plotly. (<strong>Static hosting friendly</strong>: no Python/Colab required.)</div>

    <div class="grid">
      <section class="card">
        <h2>Age Distribution of Participants</h2>
        <div id="age_hist" style="height:360px"></div>
        <div class="note" id="age_note">Most participants were between 50 and 70 years old.</div>
      </section>

      <section class="card">
        <h2>Mammography Compliance by Intervention</h2>
        <div id="compliance_bar" style="height:360px"></div>
        <div class="note">Compliance = share with 6-month screening complete.</div>
      </section>
    </div>

    <section class="card" style="margin-top:20px">
      <h2>Follow-up Cognitive Stage by Intervention</h2>
      <div id="stage_stack" style="height:420px"></div>
      <div class="note">Stacked counts by stage at follow-up.</div>
    </section>

    <div class="footer">
      Data guide: expects a file named <code>mammography_data.csv</code> in the same folder as this page. Key columns (case-insensitive):
      <code>age</code>, <code>treatment</code> (e.g., Control/Phone/Mail/Mail+Phone), <code>resp6</code> (0/1 compliance),
      and <code>stage</code> (follow-up stage like Pre/Contemplation/Action).<br>
      /* © 2025 Your Name — Publish this via GitHub Pages to meet course requirements. */
    </div>
  </div>

<script>
/* ---------- Theme + helpers ---------- */
const palette = ['#7dd3fc','#c4b5fd','#fca5a5','#fcd34d','#34d399','#f472b6'];
const baseLayout = {
  margin:{t:24,r:14,b:46,l:46},
  font:{family:'Inter, ui-sans-serif, system-ui', color:'#eaf0fb'},
  paper_bgcolor:'rgba(0,0,0,0)', plot_bgcolor:'rgba(0,0,0,0)',
  xaxis:{gridcolor:'#223147', zerolinecolor:'#223147', linecolor:'#223147', ticks:'outside', tickcolor:'#223147'},
  yaxis:{gridcolor:'#223147', zerolinecolor:'#223147', linecolor:'#223147', ticks:'outside', tickcolor:'#223147'},
  legend:{orientation:'h', bgcolor:'rgba(0,0,0,0)', bordercolor:'rgba(0,0,0,0)'},
  colorway: palette,
  hoverlabel:{bgcolor:'#0f1722', bordercolor:'#223147', font:{color:'#eaf0fb'}}
};

function findCol(cols, aliases){
  const norm = s=> String(s).toLowerCase().replace(/\W+/g,'');
  const normCols = cols.map(c=>({raw:c, k:norm(c)}));
  for(const a of aliases){
    const k = norm(a);
    const hit = normCols.find(x=>x.k===k);
    if(hit) return hit.raw;
  }
  for(const a of aliases){
    const k = norm(a);
    const hit = normCols.find(x=>x.k.includes(k) || k.includes(x.k));
    if(hit) return hit.raw;
  }
  return null;
}
const safeNumber = x => Number.isFinite(Number(x)) ? Number(x) : null;
function groupBy(arr, keyFn){
  const m = new Map();
  for(const r of arr){
    const k = keyFn(r);
    if(!m.has(k)) m.set(k, []);
    m.get(k).push(r);
  }
  return m;
}
function showError(where, msg){
  const el = document.getElementById(where);
  if(el){ el.innerHTML = `<div class="error">${msg}</div>`; }
}

/* ---------- Load CSV ---------- */
const CSV_PATH = 'mammography_data.csv';

Papa.parse(CSV_PATH, {
  download: true,
  header: true,
  dynamicTyping: false,
  skipEmptyLines: true,
  complete: function(res){
    if(!res || !res.data || !res.data.length){
      ['age_hist','compliance_bar','stage_stack'].forEach(id=>showError(id, 'No data rows found in mammography_data.csv'));
      return;
    }
    const rows = res.data;
    const cols = res.meta.fields || Object.keys(rows[0]);

    const ageCol   = findCol(cols, ['age','ages','Age']);
    const trtCol   = findCol(cols, ['treatment','treatment_f','group','arm','Treatment']);
    const respCol  = findCol(cols, ['resp6','compliance6','six_month','screen6','y','Resp6']);
    const stageCol = findCol(cols, ['stagefwup','fu_stage','followup_stage','stage','Stagefwup']);

    const data = rows.map(r=>({
      age: safeNumber(r[ageCol]),
      trt: (r[trtCol]||'').toString().trim(),
      resp: (r[respCol]||'').toString().trim(),
      stage: (r[stageCol]||'').toString().trim()
    })).filter(x=>x.trt);

    // normalize resp to 0/1
    for(const d of data){
      const s = String(d.resp).toLowerCase();
      if(s===''||s==='na'||s==='null'){ d.resp=null; continue; }
      if(['1','yes','y','true','t','compliant'].includes(s)) d.resp=1;
      else if(['0','no','n','false','f','noncompliant'].includes(s)) d.resp=0;
      else d.resp = safeNumber(d.resp);
    }

    const order = ['Control','Phone','Mail','Mail+Phone'];

    /* ---------- Figure 1: Age histogram + mean line ---------- */
    const ages = data.map(d=>d.age).filter(v=>v!=null);
    if(ages.length){
      const meanAge = ages.reduce((a,b)=>a+b,0)/ages.length;
      const hist = {
        type:'histogram',
        x: ages,
        nbinsx: 20,
        marker:{color: 'rgba(125,211,252,.85)', line:{color:'rgba(255,255,255,.25)', width:1}},
        hovertemplate:'Age: %{x}<br>Count: %{y}<extra></extra>',
        opacity: 0.95
      };
      const layout = {
        ...baseLayout,
        xaxis:{...baseLayout.xaxis, title:'Age'},
        yaxis:{...baseLayout.yaxis, title:'Count'},
        shapes:[{
          type:'line', x0:meanAge, x1:meanAge, y0:0, y1:1, yref:'paper',
          line:{color:'#c4b5fd', width:2, dash:'dash'}
        }],
        annotations:[{
          x: meanAge, y: 1, yref:'paper', xanchor:'left', yanchor:'top',
          text:`Mean: ${meanAge.toFixed(1)}`, showarrow:false, font:{size:12, color:'#c4b5fd'}
        }]
      };
      Plotly.newPlot('age_hist', [hist], layout, {displaylogo:false, responsive:true});
    }else{
      showError('age_hist','Could not find an age column. Make sure your CSV has a column named "age".');
    }

    /* ---------- Figure 2: Compliance by intervention ---------- */
    const byTrt = groupBy(data.filter(d=>d.resp!=null), d=>d.trt || 'Unknown');
    const trts = Array.from(byTrt.keys()).sort((a,b)=>{
      const ia = order.indexOf(a), ib = order.indexOf(b);
      return (ia===-1)-(ib===-1) || ia-ib || a.localeCompare(b);
    });
    const rates = trts.map(t=>{
      const arr = byTrt.get(t) || [];
      const m = arr.filter(x=>x.resp===1).length;
      return arr.length ? m/arr.length*100 : 0;
    });
    if(trts.length){
      const bar = {
        type:'bar',
        x: trts, y: rates,
        text: rates.map(v=>v.toFixed(1)+'%'), textposition:'outside',
        marker:{color: palette.map((c,i)=>palette[i%palette.length])},
        hovertemplate:'%{x}<br>Compliance: %{y:.1f}%<extra></extra>'
      };
      const layout = {
        ...baseLayout,
        xaxis:{...baseLayout.xaxis, title:'Intervention'},
        yaxis:{...baseLayout.yaxis, title:'Compliance (%)', rangemode:'tozero'},
        margin:{t:28,r:18,b:54,l:56}
      };
      Plotly.newPlot('compliance_bar', [bar], layout, {displaylogo:false, responsive:true});
    }else{
      showError('compliance_bar','Could not compute compliance — check columns treatment/resp6.');
    }

    /* ---------- Figure 3: Stacked stage by intervention ---------- */
    const stageByTrt = new Map();
    const stagesSet = new Set();
    for(const d of data){
      if(!d.trt || !d.stage) continue;
      const map = stageByTrt.get(d.trt) || new Map();
      map.set(d.stage, (map.get(d.stage)||0)+1);
      stageByTrt.set(d.trt, map);
      stagesSet.add(d.stage);
    }
    const stages = Array.from(stagesSet).sort();
    if(stageByTrt.size){
      const x = trts.length? trts : Array.from(stageByTrt.keys());
      const traces = stages.map((s, i)=>({
        type:'bar', name:s, x: x,
        y: x.map(t=> (stageByTrt.get(t)?.get(s)) || 0),
        marker:{color: palette[i%palette.length]},
        hovertemplate:'%{x}<br>'+s+': %{y}<extra></extra>'
      }));
      const layout = {
        ...baseLayout,
        barmode:'stack',
        xaxis:{...baseLayout.xaxis, title:'Intervention'},
        yaxis:{...baseLayout.yaxis, title:'Participants'},
        margin:{t:28,r:18,b:54,l:56},
        legend:{...baseLayout.legend, orientation:'h', y:-0.18}
      };
      Plotly.newPlot('stage_stack', traces, layout, {displaylogo:false, responsive:true});
    }else{
      showError('stage_stack','Could not find a follow-up stage column. Expected something like fu_stage or stagefwup.');
    }
  },
  error: function(err){
    ['age_hist','compliance_bar','stage_stack'].forEach(id=>showError(id, 'Failed to load CSV: '+err));
  }
});
</script>
</body>
</html>

