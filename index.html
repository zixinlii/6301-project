<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Visualizing the Effects of Tailored Interventions on Mammography Screening</title>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    html, body{
      margin:0;
      padding:0;
      background:#ffffff;
      color:#333333;
      font-family:"Helvetica Neue", Arial, sans-serif;
    }
    .page{
      max-width:1450px;
      margin:24px auto 32px;
      padding:0 32px;
    }
     h1{
        font-size:24px;
        font-weight:700;
        line-height:1.25;
        white-space:nowrap;   
    }

    h2{
      font-size:20px;
      font-weight:600;
      margin:0 0 8px;
    }

    .layout{
      display:grid;
      grid-template-columns: minmax(0, 1.8fr) minmax(0, 1.8fr) minmax(0, 0.4fr);
      grid-template-rows:auto auto;
      column-gap:36px;
      row-gap:32px;
      align-items:start;
    }


    .panel{
      position:relative;
    }
    .panel p{
      font-size:14px;
      line-height:1.5;
      margin-top:16px;
      margin-bottom:0;
    }

    .age-panel{   grid-column:1 / 2; grid-row:1 / 2; }
    .text-panel{  grid-column:1 / 2; grid-row:2 / 3; }

    .comp-panel{  grid-column:2 / 3; grid-row:1 / 2; }
    .stage-panel{ grid-column:2 / 3; grid-row:2 / 3; }

    .age-panel h2{
       font-size:22px; 
      white-space:nowrap;
    }

    .legend-panel{
      grid-column:3 / 4;
      grid-row:1 / 3;
      font-size:13px;
      line-height:1.5;
      align-self:flex-start;
      min-width:140px;
    }

    .legend-section{
      border-bottom:1px solid #ddd;
      margin-bottom:12px;
      padding-bottom:8px;
    }
    .legend-section:last-child{
      border-bottom:none;
      margin-bottom:0;
      padding-bottom:0;
    }

    .legend-header{
      font-weight:600;
      cursor:pointer;
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:4px 0;
    }
    .legend-header span{
      font-weight:400;
      margin-left:8px;
    }
    .legend-header:hover{
      color:#0070c9;
    }

    .legend-content{
      margin-top:6px;
      padding-left:6px;
      display:none;        
    }

    .legend-item{
      display:flex;
      align-items:center;
      margin-bottom:4px;
    }
    .legend-item:last-child{
      margin-bottom:0;
    }

    .legend-swatch{
      width:12px;
      height:12px;
      margin-right:6px;
    }

    .chart{
      width:100%;
    }
  </style>
</head>
<body>
<div class="page">
  <h1>Visualizing the Effects of Tailored Interventions on Mammography Screening</h1>

  <div class="layout">

    <section class="panel age-panel">
      <h2>Age Distribution of Participants</h2>
      <div id="age_chart" class="chart" style="height:380px;"></div>
    </section>

    <section class="panel text-panel">
      <p>
        This dashboard summarizes data from a randomized trial examining how mail and/or phone
        interventions influence mammography screening behavior. Most participants were between 50 and
        70 years old. Compliance rates increased across all intervention groups, with the Mail + Phone
        group achieving the highest rate (~39%). The cognitive stage distribution further shows that
        mailed interventions helped more women progress to the Action stage compared with usual care,
        highlighting the effectiveness of tailored communication strategies in promoting mammography
        screening adherence.
      </p>
    </section>

    <section class="panel comp-panel">
      <h2>Mammography Compliance by Intervention Group</h2>
      <div id="comp_chart" class="chart" style="height:320px;"></div>
    </section>

    <section class="panel stage-panel">
      <h2>Follow-up Cognitive Stage by Intervention Group</h2>
      <div id="stage_chart" class="chart" style="height:320px;"></div>
    </section>

    <aside class="legend-panel">

      <!-- Age Range -->
      <div class="legend-section">
        <div class="legend-header" data-target="age-legend">
          Age Range (years)
          <span>+</span>
        </div>
        <div class="legend-content" id="age-legend">
          <div class="legend-item"><span class="legend-swatch" style="background:#5b8fd6;"></span>50–54</div>
          <div class="legend-item"><span class="legend-swatch" style="background:#f39a3e;"></span>55–59</div>
          <div class="legend-item"><span class="legend-swatch" style="background:#e56767;"></span>60–64</div>
          <div class="legend-item"><span class="legend-swatch" style="background:#5ab2a6;"></span>65–69</div>
          <div class="legend-item"><span class="legend-swatch" style="background:#63a95a;"></span>70–74</div>
          <div class="legend-item"><span class="legend-swatch" style="background:#d4b548;"></span>75–79</div>
          <div class="legend-item"><span class="legend-swatch" style="background:#9a6ac6;"></span>80–84</div>
          <div class="legend-item"><span class="legend-swatch" style="background:#f08fb6;"></span>&gt;85</div>
        </div>
      </div>

      <!-- Treatment -->
      <div class="legend-section">
        <div class="legend-header" data-target="trt-legend">
          Treatment
          <span>+</span>
        </div>
        <div class="legend-content" id="trt-legend">
          <div class="legend-item"><span class="legend-swatch" style="background:#5b8fd6;"></span>Control</div>
          <div class="legend-item"><span class="legend-swatch" style="background:#f39a3e;"></span>Phone</div>
          <div class="legend-item"><span class="legend-swatch" style="background:#e56767;"></span>Mail</div>
          <div class="legend-item"><span class="legend-swatch" style="background:#5ab2a6;"></span>Mail &amp; Phone</div>
        </div>
      </div>

      <!-- Stagefwup -->
      <div class="legend-section">
        <div class="legend-header" data-target="stage-legend">
          Stagefwup
          <span>+</span>
        </div>
        <div class="legend-content" id="stage-legend">
          <div class="legend-item"><span class="legend-swatch" style="background:#5b8fd6;"></span>Precontemplation</div>
          <div class="legend-item"><span class="legend-swatch" style="background:#f39a3e;"></span>Contemplation</div>
          <div class="legend-item"><span class="legend-swatch" style="background:#e56767;"></span>Action</div>
        </div>
      </div>

    </aside>

  </div>
</div>

<script>
// ---------- helpers ----------
function num(x){
  const v = Number(x);
  return Number.isFinite(v) ? v : null;
}
function groupBy(arr, keyFn){
  const map = new Map();
  for(const row of arr){
    const k = keyFn(row);
    if(!map.has(k)) map.set(k, []);
    map.get(k).push(row);
  }
  return map;
}
function findCol(cols, aliases){
  const norm = s => String(s).toLowerCase().replace(/\W+/g,'');
  const nc = cols.map(c => ({ raw:c, k:norm(c) }));
  for(const a of aliases){
    const k = norm(a);
    const hit = nc.find(x => x.k === k);
    if(hit) return hit.raw;
  }
  for(const a of aliases){
    const k = norm(a);
    const hit = nc.find(x => x.k.includes(k) || k.includes(x.k));
    if(hit) return hit.raw;
  }
  return null;
}

// ---------- color palettes ----------
const ageColors = ['#5b8fd6','#f39a3e','#e56767','#5ab2a6',
                   '#63a95a','#d4b548','#9a6ac6','#f08fb6'];
const trtColors = {
  'Control':'#5b8fd6',
  'Phone':'#f39a3e',
  'Mail':'#e56767',
  'Mail & Phone':'#5ab2a6'
};
const stageColors = {
  'Precontemplation':'#5b8fd6',
  'Contemplation':'#f39a3e',
  'Action':'#e56767'
};

// ---------- read CSV and plot ----------
Papa.parse('mammography_data.csv', {
  download:true,
  header:true,
  skipEmptyLines:true,
  complete: function(res){
    if(!res.data || !res.data.length){
      console.error('No data rows found.');
      return;
    }
    const rows = res.data;
    const cols = res.meta.fields || Object.keys(rows[0]);

    const ageCol   = findCol(cols,['age','Age']);
    const trtCol   = findCol(cols,['treatment','Treatment','group','arm']);
    const respCol  = findCol(cols,['resp6','Resp6','compliance6','screen6']);
    const stageCol = findCol(cols,['stagefwup','Stagefwup','fu_stage','followup_stage']);

    const normalizeTrt = v => {
      const s = (v ?? '').toString().trim();
      if(s === '0') return 'Control';
      if(s === '1') return 'Phone';
      if(s === '2') return 'Mail';
      if(s === '3' || s === '3.0') return 'Mail & Phone';
      return s.replace('+',' & ');
    };
    const normalizeStage = v => {
      const s = (v ?? '').toString().toLowerCase();
      if(s.includes('pre')) return 'Precontemplation';
      if(s.includes('contem')) return 'Contemplation';
      if(s.includes('act')) return 'Action';
      if(s === '1') return 'Precontemplation';
      if(s === '2') return 'Contemplation';
      if(s === '3') return 'Action';
      return v;
    };

    const data = rows.map(r => ({
      age: num(r[ageCol]),
      trt: normalizeTrt(r[trtCol]),
      resp: (r[respCol] ?? '').toString().trim(),
      stage: normalizeStage(r[stageCol])
    }));

    // normalize resp to 0/1
    for(const d of data){
      const s = d.resp.toString().toLowerCase();
      if(s === '' || s === 'na' || s === 'null'){ d.resp = null; continue; }
      if(['1','yes','y','true','t','compliant'].includes(s)) d.resp = 1;
      else if(['0','no','n','false','f','noncompliant'].includes(s)) d.resp = 0;
      else d.resp = num(d.resp);
    }

    const trtOrder = ['Control','Phone','Mail','Mail & Phone'];

    // ---------- Age distribution ----------
    const ageBins = [
      {label:'50–54', in:a => a>=50 && a<55},
      {label:'55–59', in:a => a>=55 && a<60},
      {label:'60–64', in:a => a>=60 && a<65},
      {label:'65–69', in:a => a>=65 && a<70},
      {label:'70–74', in:a => a>=70 && a<75},
      {label:'75–79', in:a => a>=75 && a<80},
      {label:'80–84', in:a => a>=80 && a<85},
      {label:'>85',   in:a => a>=85}
    ];
    const ages = data.map(d => d.age).filter(v => v != null);
    const ageCounts = ageBins.map(bin => ages.filter(a => bin.in(a)).length);
    const maxAgeCount = Math.max(...ageCounts);

    Plotly.newPlot('age_chart', [{
      type:'bar',
      x: ageBins.map(b => b.label),
      y: ageCounts,
      marker:{
        color: ageColors,
        line:{ color:'#ffffff', width:1 }
      },
      text: ageCounts.map(String),
      textposition:'outside',
      hovertemplate:'Age Range: %{x}<br>Count: %{y}<extra></extra>'
    }], {
      margin:{t:40,r:10,b:60,l:70},
      paper_bgcolor:'rgba(0,0,0,0)',
      plot_bgcolor:'rgba(0,0,0,0)',
      showlegend:false,
      xaxis:{
        title:'Age Range (years)',
        tickfont:{size:12},
        linecolor:'#bbbbbb',
        mirror:true
      },
      yaxis:{
        title:'Number of Participants',
        range:[0, maxAgeCount + 20], 
        gridcolor:'#e5e5e5',
        zerolinecolor:'#e5e5e5',
        linecolor:'#bbbbbb',
        mirror:true,
        tickfont:{size:12}
      },
      font:{family:"Helvetica Neue, Arial, sans-serif", size:12, color:'#333333'}
    }, {displaylogo:false, responsive:true});

    // ---------- Compliance by treatment ----------
    const byTrt = groupBy(data.filter(d => d.resp != null && d.trt), d => d.trt);
    const trts = trtOrder.filter(t => byTrt.has(t));
    const rates = trts.map(t => {
      const arr = byTrt.get(t);
      const m = arr.filter(x => x.resp === 1).length;
      return arr.length ? m / arr.length * 100 : 0;
    });
    const maxRate = Math.max(...rates);

    Plotly.newPlot('comp_chart', [{
      type:'bar',
      x: trts,
      y: rates,
      marker:{
        color: trts.map(t => trtColors[t] || '#999999')
      },
      text: rates.map(v => Math.round(v) + '%'),
      textposition:'outside',
      hovertemplate:'%{x}<br>Compliance: %{y:.1f}%<extra></extra>'
    }], {
      margin:{t:40,r:10,b:60,l:80},
      paper_bgcolor:'rgba(0,0,0,0)',
      plot_bgcolor:'rgba(0,0,0,0)',
      showlegend:false,
      xaxis:{
        title:'Treatment',
        categoryorder:'array',
        categoryarray:trtOrder,
        linecolor:'#bbbbbb',
        mirror:true
      },
      yaxis:{
        title:'Mammography Compliance (%)',
        range:[0, maxRate + 5], 
        gridcolor:'#e5e5e5',
        zerolinecolor:'#e5e5e5',
        linecolor:'#bbbbbb',
        mirror:true
      },
      font:{family:"Helvetica Neue, Arial, sans-serif", size:12, color:'#333333'}
    }, {displaylogo:false, responsive:true});

    // ---------- Follow-up cognitive stage ----------
    const stageByTrt = {};
    data.forEach(d => {
      if(!d.trt || !d.stage) return;
      if(!stageByTrt[d.trt]) stageByTrt[d.trt] = {};
      const m = stageByTrt[d.trt];
      m[d.stage] = (m[d.stage] || 0) + 1;
    });

    const stageOrder = ['Precontemplation','Contemplation','Action'];
    const xTrt = trtOrder.filter(t => stageByTrt[t]);

    const totals = xTrt.map(t => {
      const m = stageByTrt[t];
      return Object.values(m).reduce((s,v) => s+v, 0) || 1;
    });

    const stageTraces = stageOrder.map(stage => ({
      type:'bar',
      name:stage,
      x:xTrt,
      y:xTrt.map((t,i) => {
        const m = stageByTrt[t] || {};
        return (m[stage] || 0) / totals[i] * 100;
      }),
      marker:{ color: stageColors[stage] || '#999999' },
      text:xTrt.map((t,i) => {
        const m = stageByTrt[t] || {};
        const val = (m[stage] || 0) / totals[i] * 100;
        return val ? val.toFixed(2) + '%' : '';
      }),
      textposition:'inside',
      insidetextanchor:'middle',
      hovertemplate:stage + ': %{y:.2f}%<extra></extra>'
    }));

    Plotly.newPlot('stage_chart', stageTraces, {
      barmode:'stack',
      margin:{t:40,r:10,b:60,l:90},
      paper_bgcolor:'rgba(0,0,0,0)',
      plot_bgcolor:'rgba(0,0,0,0)',
      showlegend:false,
      xaxis:{
        title:'Treatment',
        categoryorder:'array',
        categoryarray:trtOrder,
        linecolor:'#bbbbbb',
        mirror:true
      },
      yaxis:{
        title:'Proportion of Participants (%)',
        range:[0,100],
        gridcolor:'#e5e5e5',
        zerolinecolor:'#e5e5e5',
        linecolor:'#bbbbbb',
        mirror:true,
        ticksuffix:'%'
      },
      font:{family:"Helvetica Neue, Arial, sans-serif", size:12, color:'#333333'}
    }, {displaylogo:false, responsive:true});
  },
  error: function(err){
    console.error('Failed to load CSV:', err);
  }
});

document.querySelectorAll(".legend-header").forEach(header => {
  header.addEventListener("click", () => {
    const targetId = header.dataset.target;
    const content = document.getElementById(targetId);
    const expanded = content.style.display === "block";

    content.style.display = expanded ? "none" : "block";
    header.querySelector("span").textContent = expanded ? "+" : "−";
  });
});
</script>
</body>
</html>
